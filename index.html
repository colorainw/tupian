<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高级图片墙</title>
    <link rel="icon" href="./01.jpg" sizes="16x16">
    <style>
        /* 原有基础样式保持不变 */
        /* 新增扩展样式 */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }
        
        .context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .context-menu-item:hover {
            background: #f5f5f5;
        }
        
        .stats-bar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 14px;
        }
        
        .hotkey-hint {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            padding: 8px 12px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- 原有HTML结构保持不变 -->
    <div class="hotkey-hint">快捷键：R - 刷新全部 | S - 保存当前</div>
    <div class="stats-bar">已加载：<span id="loadCount">0</span> 次</div>
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" data-action="save">保存图片</div>
        <div class="context-menu-item" data-action="refresh">刷新图片</div>
        <div class="context-menu-item" data-action="copy">复制链接</div>
    </div>

    <script>
        // 状态管理对象
        const appState = {
            loadCount: 0,
            currentTarget: null,
            menuVisible: false
        };

        // 右键菜单处理
        document.querySelectorAll('.column').forEach(column => {
            column.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                appState.currentTarget = column.querySelector('img');
                showContextMenu(e.clientX, e.clientY);
            });
        });

        // 显示自定义右键菜单
        function showContextMenu(x, y) {
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'block';
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            appState.menuVisible = true;
        }

        // 隐藏菜单
        document.addEventListener('click', () => {
            if(appState.menuVisible) {
                document.getElementById('contextMenu').style.display = 'none';
                appState.menuVisible = false;
            }
        });

        // 菜单功能实现
        document.getElementById('contextMenu').addEventListener('click', (e) => {
            const action = e.target.dataset.action;
            if(!action) return;

            switch(action) {
                case 'save':
                    saveImage(appState.currentTarget);
                    break;
                case 'refresh':
                    loadImage(appState.currentTarget);
                    break;
                case 'copy':
                    navigator.clipboard.writeText(appState.currentTarget.src);
                    showToast('链接已复制');
                    break;
            }
        });

        // 图片保存功能
        async function saveImage(img) {
            try {
                const response = await fetch(img.src);
                const blob = await response.blob();
                const link = document.createElement('a');
                link.download = `image_${Date.now()}.jpg`;
                link.href = URL.createObjectURL(blob);
                link.click();
                showToast('保存成功');
            } catch (error) {
                showToast('保存失败：跨域限制');
            }
        }

        // 键盘快捷键支持
        document.addEventListener('keydown', (e) => {
            if(e.key === 'r' || e.key === 'R') {
                document.querySelectorAll('.column img').forEach(img => loadImage(img));
                showToast('正在刷新全部图片...');
            }
            
            if((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if(appState.currentTarget) saveImage(appState.currentTarget);
            }
        });

        // 加载统计
        function updateStats() {
            document.getElementById('loadCount').textContent = appState.loadCount;
        }

        // 修改原有loadImage函数
        function loadImage(imgElement, isInitial = false) {
            // ...原有逻辑...
            tempImg.onload = () => {
                appState.loadCount++;
                updateStats();
                // ...后续逻辑...
            }
        }

        // 提示信息组件
        function showToast(message, duration=2000) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.background = '#333';
            toast.style.color = 'white';
            toast.style.padding = '10px 20px';
            toast.style.borderRadius = '5px';
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, duration);
        }

        // 初始化统计
        updateStats();
    </script>
</body>
</html>
